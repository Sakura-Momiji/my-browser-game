<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>シミュレーション ステップ3 勝敗選択式</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #fafafa; }
  #info { margin: 10px; }
  #board {
    display: grid;
    margin: 20px auto;
    border: 2px solid #333;
  }
  .cell {
    width: 50px; height: 50px;
    border: 1px solid #ccc;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    font-size: 12px;
    position: relative;
  }
  .highlight { background: yellow !important; }
  .red { background: #f88; }
  .blue { background: #88f; color: white; }
  .abyss { background: black; }
  .respawn-red { background: pink; }
  .respawn-blue { background: lightblue; }

  /* モーダル */
  .modal {
    display: none; position: fixed; top:0; left:0;
    width:100%; height:100%; background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
  }
  .modal-content {
    background: white; padding: 20px; border-radius: 10px;
    text-align: center; min-width: 250px;
  }
</style>
</head>
<body>
  <h1>シミュレーション ステップ3（勝者を選べるバトル）</h1>
  <div id="info">
    <span id="turnInfo">準備段階</span>
    <span id="phaseInfo"></span>
  </div>
  <button id="startBtn">ゲーム開始</button>
  <button id="moveEndBtn" disabled>移動完了</button>
  <div id="board"></div>

  <!-- バトル結果選択モーダル -->
  <div id="battleModal" class="modal">
    <div class="modal-content">
      <h3>戦闘発生！</h3>
      <p id="battleText"></p>
      <button id="attackerWinBtn">攻撃側の勝ち</button>
      <button id="defenderWinBtn">防御側の勝ち</button>
    </div>
  </div>

  <script>
    const board = document.getElementById("board");
    const turnInfo = document.getElementById("turnInfo");
    const phaseInfo = document.getElementById("phaseInfo");
    const startBtn = document.getElementById("startBtn");
    const moveEndBtn = document.getElementById("moveEndBtn");

    const battleModal = document.getElementById("battleModal");
    const battleText = document.getElementById("battleText");
    const attackerWinBtn = document.getElementById("attackerWinBtn");
    const defenderWinBtn = document.getElementById("defenderWinBtn");

    let boardSize = 5;
    let gamePhase = 0; // 0=準備, 1=赤ターン, 2=青ターン...
    let currentTeam = "red";
    let moveMode = false;
    let movingPiece = null;
    let moveRange = 3; // 仮：移動距離

    // バトル一時保存
    let currentBattle = null;

    function createBoard(size){
      board.innerHTML = "";
      board.style.gridTemplateColumns = `repeat(${size}, 50px)`;
      for(let y=0;y<size;y++){
        for(let x=0;x<size;x++){
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.x = x;
          cell.dataset.y = y;

          cell.addEventListener("click", () => handleCellClick(cell));
          board.appendChild(cell);
        }
      }
    }

    function handleCellClick(cell){
      if(gamePhase===0){
        // 準備段階 → 交互に赤青の駒を置ける
        if(cell.textContent===""){
          cell.classList.add(currentTeam);
          cell.textContent = currentTeam==="red" ? "R" : "B";
          currentTeam = currentTeam==="red" ? "blue" : "red";
        }
      }else{
        // ゲーム中
        if(moveMode){
          if(cell.classList.contains("highlight")){
            attemptMove(cell);
          }
        }else{
          if(cell.textContent!=="" && cell.classList.contains(currentTeam)){
            movingPiece = {cell:cell, color:currentTeam, name:cell.textContent};
            showMoveRange(cell, moveRange);
            moveMode = true;
          }
        }
      }
    }

    function attemptMove(targetCell){
      if(targetCell.textContent!=="" && !targetCell.classList.contains(currentTeam)){
        // バトル開始
        let defenderColor = targetCell.classList.contains("red") ? "red" : "blue";
        let defenderName = targetCell.textContent;
        currentBattle = {attacker:movingPiece, defender:{cell:targetCell, color:defenderColor, name:defenderName}};
        showBattleModal();
      }else{
        movePieceTo(targetCell);
        endMove();
      }
      clearHighlights();
      moveMode = false;
    }

    function showBattleModal(){
      battleText.textContent = `${movingPiece.name}（攻撃側） vs ${currentBattle.defender.name}（防御側）`;
      battleModal.style.display="flex";
    }

    attackerWinBtn.onclick = () => {
      // 防御側を削除
      let defender = currentBattle.defender;
      defender.cell.textContent="";
      defender.cell.classList.remove(defender.color);
      movePieceTo(defender.cell);
      battleModal.style.display="none";
      endMove();
    };

    defenderWinBtn.onclick = () => {
      // 攻撃側を削除
      let attacker = currentBattle.attacker;
      attacker.cell.textContent="";
      attacker.cell.classList.remove(attacker.color);
      battleModal.style.display="none";
      endMove();
    };

    function movePieceTo(cell){
      movingPiece.cell.textContent = "";
      movingPiece.cell.classList.remove(movingPiece.color);
      cell.textContent = movingPiece.name;
      cell.classList.add(movingPiece.color);
      movingPiece.cell = cell;
    }

    function endMove(){
      movingPiece = null;
      moveEndBtn.disabled = false;
    }

    function showMoveRange(cell, range){
      clearHighlights();
      const x = parseInt(cell.dataset.x);
      const y = parseInt(cell.dataset.y);
      for(let dx=-range; dx<=range; dx++){
        for(let dy=-range; dy<=range; dy++){
          if(Math.abs(dx)+Math.abs(dy) <= range){
            let nx=x+dx, ny=y+dy;
            if(nx>=0 && nx<boardSize && ny>=0 && ny<boardSize){
              const target = getCell(nx,ny);
              if(!target.classList.contains("abyss")){
                target.classList.add("highlight");
              }
            }
          }
        }
      }
    }

    function clearHighlights(){
      document.querySelectorAll(".highlight").forEach(c=>c.classList.remove("highlight"));
    }

    function getCell(x,y){
      return [...board.children].find(c=>c.dataset.x==x && c.dataset.y==y);
    }

    // ゲーム開始
    startBtn.onclick = () => {
      gamePhase = 1;
      currentTeam = "red";
      updateTurnInfo();
    };

    // 移動完了 → ターン終了
    moveEndBtn.onclick = () => {
      moveEndBtn.disabled = true;
      endTurn();
    };

    function endTurn(){
      gamePhase++;
      currentTeam = (gamePhase%2===1) ? "red" : "blue";
      updateTurnInfo();
    }

    function updateTurnInfo(){
      if(gamePhase===0){
        turnInfo.textContent="準備段階";
        phaseInfo.textContent="";
      }else{
        turnInfo.textContent = currentTeam==="red" ? "赤のターン" : "青のターン";
        phaseInfo.textContent = `(フェーズ${gamePhase})`;
      }
    }

    createBoard(boardSize);
    updateTurnInfo();
  </script>
</body>
</html>
