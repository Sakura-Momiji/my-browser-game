<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>シミュレーション ステップ2</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #fafafa; }
  #info { margin: 10px; }
  #board {
    display: grid;
    margin: 20px auto;
    border: 2px solid #333;
  }
  .cell {
    width: 50px; height: 50px;
    border: 1px solid #ccc;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    font-size: 12px;
    position: relative;
  }
  .highlight { background: yellow !important; }
  .red { background: #f88; }
  .blue { background: #88f; color: white; }
  .abyss { background: black; }
  .respawn-red { background: pink; }
  .respawn-blue { background: lightblue; }

  .modal {
    display: none; position: fixed; top:0; left:0;
    width:100%; height:100%; background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
  }
  .modal-content {
    background: white; padding: 20px; border-radius: 10px; width: 300px;
    text-align: left; position: relative;
  }
  .closeBtn { position: absolute; top:5px; right:10px; cursor: pointer; color: red; }
</style>
</head>
<body>
  <h1>シミュレーション ステップ2</h1>
  <div id="info">
    <span id="turnInfo">準備段階</span>
    <span id="phaseInfo"></span>
  </div>
  <button id="settingsBtn">設定</button>
  <button id="startBtn">ゲーム開始</button>
  <button id="moveEndBtn" disabled>移動完了</button>
  <div id="board"></div>

  <!-- 配置モーダル -->
  <div id="placeModal" class="modal">
    <div class="modal-content">
      <span class="closeBtn" id="closePlace">×</span>
      <h2 id="modalTitle">配置</h2>
      <label>
        種類:
        <select id="typeSelect">
          <option value="piece">コマ</option>
          <option value="gimmick">ギミック</option>
        </select>
      </label>
      <div id="pieceOptions">
        <label>色:
          <select id="pieceColor">
            <option value="red">赤</option>
            <option value="blue">青</option>
          </select>
        </label><br>
        <label>種類:
          <select id="pieceType">
            <option>ポーン</option>
            <option>ナイト</option>
            <option>ルーク</option>
            <option>クイーン</option>
            <option>キング</option>
          </select>
        </label><br>
        <label>名前:<input type="text" id="pieceName"></label>
      </div>
      <div id="gimmickOptions" style="display:none;">
        <label>種類:
          <select id="gimmickType">
            <option value="abyss">奈落</option>
            <option value="respawn">リスポーンエリア</option>
          </select>
        </label><br>
        <label id="respawnColorLabel">色:
          <select id="respawnColor">
            <option value="red">赤</option>
            <option value="blue">青</option>
          </select>
        </label>
      </div>
      <br>
      <button id="applyPlace">適用</button>
    </div>
  </div>

  <script>
    const board = document.getElementById("board");
    const placeModal = document.getElementById("placeModal");
    const closePlace = document.getElementById("closePlace");
    const typeSelect = document.getElementById("typeSelect");
    const pieceOptions = document.getElementById("pieceOptions");
    const gimmickOptions = document.getElementById("gimmickOptions");
    const pieceColor = document.getElementById("pieceColor");
    const pieceType = document.getElementById("pieceType");
    const pieceName = document.getElementById("pieceName");
    const gimmickType = document.getElementById("gimmickType");
    const respawnColor = document.getElementById("respawnColor");
    const applyPlace = document.getElementById("applyPlace");
    const turnInfo = document.getElementById("turnInfo");
    const phaseInfo = document.getElementById("phaseInfo");
    const startBtn = document.getElementById("startBtn");
    const moveEndBtn = document.getElementById("moveEndBtn");

    let boardSize = 5;
    let selectedCell = null;
    let gamePhase = 0; // 0=準備, 1=赤ターン, 2=青ターン, 3=赤ターン…
    let currentTeam = "red";
    let moveMode = false;
    let movingPiece = null;
    let moveRange = 3; // 仮：移動距離は3固定

    function createBoard(size){
      board.innerHTML = "";
      board.style.gridTemplateColumns = `repeat(${size}, 50px)`;
      for(let y=0;y<size;y++){
        for(let x=0;x<size;x++){
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.x = x;
          cell.dataset.y = y;

          cell.addEventListener("click", () => {
            if(gamePhase===0){
              // 配置モード
              selectedCell = cell;
              pieceName.value = "";
              placeModal.style.display="flex";
            }else{
              // 移動モード
              if(moveMode){
                if(cell.classList.contains("highlight")){
                  // 仮移動
                  movingPiece.cell.textContent = "";
                  movingPiece.cell.classList.remove(movingPiece.color);
                  cell.textContent = movingPiece.name;
                  cell.classList.add(movingPiece.color);
                  movingPiece.newCell = cell;
                  clearHighlights();
                  moveMode = false;
                  moveEndBtn.disabled = false;
                }
              }else{
                if(cell.textContent!=="" && cell.classList.contains(currentTeam)){
                  // コマをクリック → 移動範囲表示
                  movingPiece = {cell:cell, color:currentTeam, name:cell.textContent};
                  showMoveRange(cell, moveRange);
                  moveMode = true;
                }
              }
            }
          });
          board.appendChild(cell);
        }
      }
    }

    function numToCol(n){
      let s="";
      while(n>=0){
        s=String.fromCharCode(n%26+65)+s;
        n=Math.floor(n/26)-1;
      }
      return s;
    }

    // 移動範囲を色付け
    function showMoveRange(cell, range){
      clearHighlights();
      const x = parseInt(cell.dataset.x);
      const y = parseInt(cell.dataset.y);
      for(let dx=-range; dx<=range; dx++){
        for(let dy=-range; dy<=range; dy++){
          if(Math.abs(dx)+Math.abs(dy) <= range){
            let nx=x+dx, ny=y+dy;
            if(nx>=0 && nx<boardSize && ny>=0 && ny<boardSize){
              const target = getCell(nx,ny);
              if(!target.classList.contains(currentTeam) && !target.classList.contains("abyss")){
                target.classList.add("highlight");
              }
            }
          }
        }
      }
    }

    function clearHighlights(){
      document.querySelectorAll(".highlight").forEach(c=>c.classList.remove("highlight"));
    }

    function getCell(x,y){
      return [...board.children].find(c=>c.dataset.x==x && c.dataset.y==y);
    }

    // モーダル切替
    typeSelect.onchange = () => {
      if(typeSelect.value==="piece"){
        pieceOptions.style.display="block";
        gimmickOptions.style.display="none";
      }else{
        pieceOptions.style.display="none";
        gimmickOptions.style.display="block";
      }
    };

    // 適用
    applyPlace.onclick = () => {
      if(!selectedCell) return;
      selectedCell.className="cell";
      selectedCell.textContent="";
      if(typeSelect.value==="piece"){
        let color = pieceColor.value;
        let name = pieceName.value || pieceType.value;
        selectedCell.classList.add(color);
        selectedCell.textContent=name;
      }else{
        if(gimmickType.value==="abyss"){
          selectedCell.classList.add("abyss");
        }else{
          let color = respawnColor.value;
          selectedCell.classList.add("respawn-"+color);
          selectedCell.textContent="R";
        }
      }
      placeModal.style.display="none";
    };
    closePlace.onclick = ()=> placeModal.style.display="none";

    // ゲーム開始
    startBtn.onclick = () => {
      gamePhase = 1;
      currentTeam = "red";
      updateTurnInfo();
    };

    // 移動完了
    moveEndBtn.onclick = () => {
      if(movingPiece && movingPiece.newCell){
        movingPiece.newCell.textContent = movingPiece.name;
        movingPiece.newCell.classList.add(movingPiece.color);
        movingPiece.cell = movingPiece.newCell;
        movingPiece.newCell = null;
      }
      movingPiece = null;
      moveMode = false;
      clearHighlights();
      moveEndBtn.disabled = true;
      endTurn();
    };

    function endTurn(){
      gamePhase++;
      currentTeam = (gamePhase%2===1) ? "red" : "blue";
      updateTurnInfo();
    }

    function updateTurnInfo(){
      if(gamePhase===0){
        turnInfo.textContent="準備段階";
        phaseInfo.textContent="";
      }else{
        turnInfo.textContent = currentTeam==="red" ? "赤のターン" : "青のターン";
        phaseInfo.textContent = `(フェーズ${gamePhase})`;
      }
    }

    createBoard(boardSize);
    updateTurnInfo();
  </script>
</body>
</html>
